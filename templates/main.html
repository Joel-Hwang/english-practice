<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Practice</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap 5 CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container mt-5" style="max-width: 1000px" id="practice">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">English Practice</h5>
        <span class="text-muted" id="questionProgress">1/10</span>
      </div>

      <div class="progress mb-3" style="height: 6px">
        <div
          id="progress"
          class="progress-bar bg-primary"
          role="progressbar"
          style="width: 10%"
          aria-valuenow="10"
          aria-valuemin="0"
          aria-valuemax="100"
        ></div>
      </div>

      <div class="mb-4">
        <strong class="fs-5" id="question"></strong>
      </div>

      <div class="mb-3">
        <button class="btn btn btn-primary w-100" id="btnStart">ğŸ¤</button>
      </div>
      <div class="form-floating" style="margin-bottom: 10px">
        <textarea
          class="form-control"
          id="sentences"
          style="height: 150px"
        ></textarea>
        <label for="sentences">Type or speak your sentences here</label>
      </div>

      <button
        class="btn btn-primary w-100"
        onclick="handleSubmit()"
        id="btnSubmit"
      >
        Submit
      </button>
      <div>
        <p id="original"></p>
        <p><strong id="corrected"></strong></p>
        <ul class="list-group list-group-flush" id="explanations"></ul>
      </div>
    </div>

    <div id="card-container" class="d-flex flex-wrap"></div>

    <template id="card-template">
      <div
        class="card"
        style="max-width: 11.5rem; margin: 0.2rem; cursor: pointer"
      >
        <img class="card-img-top" />
        <div class="card-body">
          <h5 class="card-title" style="text-align: center"></h5>
          <p class="card-text"></p>
          <span
            class="d-inline-block text-truncate"
            style="max-width: 100%"
          ></span>
        </div>
      </div>
    </template>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const btnSubmit = document.getElementById("btnSubmit");
      const btnStart = document.getElementById("btnStart");
      const txtSentences = document.getElementById("sentences");
      const spanQuestion = document.getElementById("question");
      let gQuestions = [];
      let gCurrentQuestionIndex = 0;
      let recognition = null;
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      let isManuallyStopped = true;

      if (!SpeechRecognition) {
        alert("Your browser does not support Speech Recognition.");
      } else {
        recognition = new SpeechRecognition();

        // Set language to English (US)
        recognition.lang = "en-US";
        recognition.interimResults = false; // No intermediate results
        recognition.maxAlternatives = 1;
        recognition.continuous = true;

        btnStart.onclick = () => {
          if (isManuallyStopped) record();
          else cancelRecord();
        };

        recognition.onresult = (event) => {
          let transcript = "";

          for (let i = event.resultIndex; i < event.results.length; ++i) {
            const res = event.results[i];
            transcript = res[0].transcript;

            if (res.isFinal) txtSentences.value += transcript + "\n";
          }
        };

        recognition.onerror = (event) => {
          document.getElementById(
            "corrected"
          ).value = `âŒ Error: ${event.error}`;
        };

        recognition.onend = () => {
          if (!isManuallyStopped) {
            recognition.start(); // ìë™ ì¬ì‹œì‘
          }
        };
      }
      window.onload = async () => {
        await getQuestions();
        await getHistories(1, displayCards);
        displayQuestion();
      };

      function displayCards(histories) {
        const container = document.getElementById("card-container");
        container.innerHTML = "";
        const template = document.getElementById("card-template");
        histories.forEach((item) => {
          const clone = template.content.cloneNode(true);
          const reply = JSON.parse(item.reply);
          // ì´ë¯¸ì§€
          clone.querySelector(".card-img-top").src =
            "./images/" + reply.conversational_fluency_score + ".png";
          clone.querySelector(".card").onclick = () => {
            window.location.href = `/detail/${item._id}`;
          };
          // ë‚ ì§œ
          clone.querySelector(".card-title").textContent = formattedDate(
            item.createdAt
          );
          // ë³¸ë¬¸ í…ìŠ¤íŠ¸
          clone.querySelector(".card-text").textContent = item.question;
          // ì˜ë¦´ í…ìŠ¤íŠ¸
          clone.querySelector("span").textContent = reply.explanations;
          // ì¹´ë“œ ì‚½ì…
          container.appendChild(clone);
        });

        if (
          histories.length > 0 &&
          gQuestions.includes(histories[0].question)
        ) {
          gCurrentQuestionIndex = histories[0].questionIndex + 1;
          spanQuestion.textContent = gQuestions[gCurrentQuestionIndex];
          setProgress(gCurrentQuestionIndex + 1, gQuestions.length);
        }
      }

      function record() {
        isManuallyStopped = false;
        recognition.start();
        btnStart.innerText = "ğŸš«";
      }

      function cancelRecord() {
        btnStart.innerText = "ğŸ¤";
        isManuallyStopped = true;
        recognition.stop();
      }

      function resetComponents() {
        const original = document.getElementById("original");
        original.textContent = "";
        const corrected = document.getElementById("corrected");
        corrected.textContent = "";
        const explanations = document.getElementById("explanations");
        explanations.innerHTML = "";
      }

      function getQuestions() {
        fetch("questions", { method: "GET" })
          .then((response) => {
            if (!response.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
            return response.json();
          })
          .then((data) => {
            gQuestions = data;
            gCurrentQuestionIndex = 0;
            spanQuestion.textContent = gQuestions[gCurrentQuestionIndex];
            setProgress(gCurrentQuestionIndex + 1, gQuestions.length);
          })
          .catch((error) => {
            console.error("ì—ëŸ¬ ë°œìƒ:", error);
          });
      }

      function getHistories(page, callback) {
        fetch("histories?page=" + page + "&size=10", { method: "GET" })
          .then((response) => {
            if (!response.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
            return response.json();
          })
          .then((data) => {
            callback(data);
          })
          .catch((error) => {
            console.error("ì—ëŸ¬ ë°œìƒ:", error);
          });
      }

      function handleSubmit() {
        if (txtSentences.value.trim() === "") {
          alert("Please enter a sentence.");
          return;
        }
        btnSubmit.disabled = true;
        btnSubmit.textContent = "Processing...";
        btnStart.disabled = true;
        const sentence = txtSentences.value;
        resetComponents();
        cancelRecord();
        fetch("chat", {
          method: "POST", // POST ìš”ì²­
          headers: {
            "Content-Type": "application/json", // JSON íƒ€ì… ëª…ì‹œ
          },
          body: JSON.stringify({
            sentence,
            question: spanQuestion.textContent,
            questionIndex: gCurrentQuestionIndex,
          }),
        })
          .then((response) => {
            if (!response.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
            return response.json(); // JSON ì‘ë‹µ íŒŒì‹±
          })
          .then((data) => {
            const json = extractJSON(data.reply);
            original.textContent = "ì›ë³¸ ë¬¸ì¥: " + sentence;
            corrected.textContent = "êµì •ëœ ë¬¸ì¥: " + json.corrected;
            for (let i = 0; i < json.explanations?.length || 0; i++) {
              explanations.insertAdjacentHTML(
                "beforeend",
                `<li class="list-group-item">${i + 1}. ${
                  json.explanations[i]
                }</li>`
              );
            }

            gCurrentQuestionIndex++;
            displayQuestion();
            spanQuestion.textContent = gQuestions[gCurrentQuestionIndex];
            setProgress(gCurrentQuestionIndex + 1, gQuestions.length);
          })
          .catch((error) => {
            console.error("ì—ëŸ¬ ë°œìƒ:", error);
          })
          .finally(() => {
            btnSubmit.disabled = false;
            btnSubmit.textContent = "Submit";
            btnStart.disabled = false;
            txtSentences.value = "";
            getHistories(1, displayCards);
          });
      }

      function displayQuestion() {
        if (gCurrentQuestionIndex >= gQuestions.length)
          document.getElementById("practice").style.display = "none";
        else document.getElementById("practice").style.display = "block";
      }
      function setProgress(count, total) {
        const percent = Math.round((count / total) * 100);
        const bar = document.getElementById("progress");
        bar.style.width = `${percent}%`; // ì‹œê°ì ìœ¼ë¡œ ë„ˆë¹„ ì¡°ì ˆ
        bar.setAttribute("aria-valuenow", percent); // ì ‘ê·¼ì„± ì†ì„±ë„ ê°±ì‹ 
        const questionProgress = document.getElementById("questionProgress");
        questionProgress.textContent = `${count}/${total}`;
      }

      function extractJSON(text) {
        const jsonMatch = text.match(/^\s*({[\s\S]*?})/m);
        if (jsonMatch) {
          try {
            const jsonObject = JSON.parse(jsonMatch[1]);
            return jsonObject;
          } catch (e) {
            console.error("JSON íŒŒì‹± ì—ëŸ¬:", e);
            return null;
          }
          return;
        }
        return null;
      }

      function formattedDate(datestring) {
        const clean = datestring.slice(0, 23) + "Z";
        const date = new Date(clean);
        const formatted = date.toLocaleString("ko-KR", {
          timeZone: "Asia/Seoul",
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
        });

        return formatted;
      }
    </script>
  </body>
</html>
