<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Practice</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap 5 CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light" style="margin: 10px">
    <div class="mb-4">
      <h5>Question</h5>
      <p class="mb-0">{{ reply.question }}</p>
    </div>

    <div class="mb-4">
      <h5>Your Answer</h5>
      <p class="mb-0">{{ reply.answer }}</p>
    </div>
    <div class="mb-4">
      <h5>Corrected Answer</h5>
      <p class="mb-0">{{ reply.corrected }}</p>
    </div>

    <div class="mb-4">
      <h5>Corrections</h5>
      <ul class="list-group list-group-flush" id="explanations">
        {% for explanation in reply.explanations %}
        <li class="list-group-item">{{ explanation }}</li>
        {% endfor %}
      </ul>
    </div>

    <div>
      <button class="btn" id="btnStart">🔴 Record</button>
    </div>
    <div
      class="d-flex align-items-start"
      id="recordArea"
      style="justify-content: center; flex-wrap: wrap"
    ></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const spanResult = document.getElementById("spanResult");
      const btnStart = document.getElementById("btnStart");
      let isManuallyStopped = true;
      window.onload = () => {
        recorder.init();
      };
      let recorder = {
        mediaRecorder: {},
        chunks: [],
        init: () => {
          const audioCtx = new (window.AudioContext ||
            window.webkitAudioContext)(); // 오디오 컨텍스트 정의
          const analyser = audioCtx.createAnalyser();
          //const distortion = audioCtx.createWaveShaper()
          //const gainNode = audioCtx.createGain()
          //const biquadFilter = audioCtx.createBiquadFilter()
          navigator.mediaDevices
            .getUserMedia({ audio: true })
            .then((stream) => {
              recorder.mediaRecorder = new MediaRecorder(stream);
              recorder.mediaRecorder.onstop = recorder.addPlayer;

              recorder.mediaRecorder.ondataavailable = (e) => {
                recorder.chunks.push(e.data);
              };
            });
        },
        start: () => {
          recorder.mediaRecorder.start();
        },
        stop: () => {
          recorder.mediaRecorder.stop();
        },
        addPlayer: (e) => {
          console.log("data available after MediaRecorder.stop() called.");
          const clipContainer = document.createElement("article");
          const clipLabel = document.createElement("p");
          const audio = document.createElement("audio");
          clipContainer.classList.add("clip");
          audio.setAttribute("controls", "");
          audio.style.width = "250px";
          clipContainer.appendChild(audio);
          audio.controls = true;
          const blob = new Blob(recorder.chunks, {
            type: "audio/ogg codecs=opus",
          });
          recorder.chunks = [];
          const audioURL = URL.createObjectURL(blob);
          audio.src = audioURL;
          console.log("recorder stopped");

          let html = `
                <div class="card" style="width: 18rem; margin: 10px;">
                    <div class="card-body">
                    </div>
                </div>`;
          const template = document.createElement("template");
          template.innerHTML = html;
          template.content
            .querySelector(".card-body")
            .appendChild(clipContainer);
          document.querySelector("#recordArea").prepend(template.content);
        },
      };

      btnStart.onclick = () => {
        if (isManuallyStopped) record();
        else cancelRecord();
      };

      function record() {
        isManuallyStopped = false;
        btnStart.innerText = "🚫 Stop";
        recorder.start();
      }

      function cancelRecord() {
        btnStart.innerText = "🔴 Record";
        isManuallyStopped = true;
        recorder.stop();
      }
    </script>
  </body>
</html>
